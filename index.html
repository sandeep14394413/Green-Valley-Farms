import React, { useState, useEffect } from 'react';
import { Leaf, ShoppingCart, Phone, Mail, MapPin, User, Package, TrendingUp, Award, Users, Heart, Star, CheckCircle, Clock, Truck, Shield, X } from 'lucide-react';

const GreenValleyFarms = () => {
  const [activeSection, setActiveSection] = useState('home');
  const [showLogin, setShowLogin] = useState(false);
  const [showRegister, setShowRegister] = useState(false);
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [currentUser, setCurrentUser] = useState(null);
  const [cart, setCart] = useState([]);
  const [orders, setOrders] = useState([]);
  const [customers, setCustomers] = useState([]);
  const [mousePos, setMousePos] = useState({ x: 0, y: 0 });
  const [currency, setCurrency] = useState('USD');
  const [language, setLanguage] = useState('EN');
  const [showCurrencyMenu, setShowCurrencyMenu] = useState(false);
  const [showLanguageMenu, setShowLanguageMenu] = useState(false);
  
  const [loginForm, setLoginForm] = useState({ email: '', password: '' });
  const [registerForm, setRegisterForm] = useState({
    name: '', email: '', phone: '', address: '', password: ''
  });
  const [orderForm, setOrderForm] = useState({
    customerName: '', phone: '', address: '', items: '', notes: ''
  });

  const currencies = {
    USD: { symbol: '$', rate: 0.012, flag: 'ðŸ‡ºðŸ‡¸' },
    EUR: { symbol: 'â‚¬', rate: 0.011, flag: 'ðŸ‡ªðŸ‡º' },
    GBP: { symbol: 'Â£', rate: 0.0095, flag: 'ðŸ‡¬ðŸ‡§' },
    INR: { symbol: 'â‚¹', rate: 1, flag: 'ðŸ‡®ðŸ‡³' },
    AUD: { symbol: 'A$', rate: 0.018, flag: 'ðŸ‡¦ðŸ‡º' },
    CAD: { symbol: 'C$', rate: 0.017, flag: 'ðŸ‡¨ðŸ‡¦' },
    JPY: { symbol: 'Â¥', rate: 1.8, flag: 'ðŸ‡¯ðŸ‡µ' },
  };

  const languages = {
    EN: { name: 'English', flag: 'ðŸ‡¬ðŸ‡§' },
    ES: { name: 'EspaÃ±ol', flag: 'ðŸ‡ªðŸ‡¸' },
    FR: { name: 'FranÃ§ais', flag: 'ðŸ‡«ðŸ‡·' },
    DE: { name: 'Deutsch', flag: 'ðŸ‡©ðŸ‡ª' },
    HI: { name: 'à¤¹à¤¿à¤‚à¤¦à¥€', flag: 'ðŸ‡®ðŸ‡³' },
    ZH: { name: 'ä¸­æ–‡', flag: 'ðŸ‡¨ðŸ‡³' },
  };

  const convertPrice = (priceINR) => {
    const converted = priceINR * currencies[currency].rate;
    return `${currencies[currency].symbol}${converted.toFixed(2)}`;
  };

  // LocalStorage helper functions (replacing window.storage)
  const storageGet = (key) => {
    try {
      const item = localStorage.getItem(key);
      return item ? JSON.parse(item) : null;
    } catch (e) {
      return null;
    }
  };

  const storageSet = (key, value) => {
    try {
      localStorage.setItem(key, JSON.stringify(value));
      return true;
    } catch (e) {
      return false;
    }
  };

  const storageDelete = (key) => {
    try {
      localStorage.removeItem(key);
      return true;
    } catch (e) {
      return false;
    }
  };

  const storageList = (prefix) => {
    try {
      const keys = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith(prefix)) {
          keys.push(key);
        }
      }
      return keys;
    } catch (e) {
      return [];
    }
  };

  useEffect(() => {
    const handleMouse = (e) => setMousePos({ x: e.clientX, y: e.clientY });
    window.addEventListener('mousemove', handleMouse);
    loadCustomers();
    loadOrders();
    checkLogin();
    return () => window.removeEventListener('mousemove', handleMouse);
  }, []);

  const checkLogin = () => {
    try {
      const session = storageGet('farm_session');
      if (session) {
        setCurrentUser(session);
        setIsLoggedIn(true);
      }
    } catch (e) {}
  };

  const loadCustomers = () => {
    try {
      const keys = storageList('customer:');
      const loaded = keys.map(key => storageGet(key)).filter(Boolean);
      setCustomers(loaded);
    } catch (e) {}
  };

  const loadOrders = () => {
    try {
      const keys = storageList('order:');
      const loaded = keys.map(key => storageGet(key)).filter(Boolean);
      setOrders(loaded);
    } catch (e) {}
  };

  const handleRegister = () => {
    if (!registerForm.name || !registerForm.email || !registerForm.password) {
      alert('Please fill all required fields');
      return;
    }
    try {
      const id = `customer:${Date.now()}`;
      const customer = {
        id, ...registerForm,
        registeredAt: new Date().toISOString(),
        totalOrders: 0
      };
      storageSet(id, customer);
      loadCustomers();
      setRegisterForm({ name: '', email: '', phone: '', address: '', password: '' });
      setShowRegister(false);
      alert('âœ… Registration successful! Please login.');
    } catch (e) {
      alert('Registration failed');
    }
  };

  const handleLogin = () => {
    const customer = customers.find(c => c.email === loginForm.email && c.password === loginForm.password);
    if (customer) {
      storageSet('farm_session', customer);
      setCurrentUser(customer);
      setIsLoggedIn(true);
      setShowLogin(false);
      setLoginForm({ email: '', password: '' });
    } else {
      alert('Invalid credentials');
    }
  };

  const handleLogout = () => {
    try {
      storageDelete('farm_session');
      setIsLoggedIn(false);
      setCurrentUser(null);
      setCart([]);
    } catch (e) {}
  };

  const placeOrder = () => {
    if (!orderForm.customerName || !orderForm.phone || !orderForm.items) {
      alert('Please fill required fields');
      return;
    }
    try {
      const id = `order:${Date.now()}`;
      const order = {
        id, ...orderForm,
        customerId: currentUser?.id || 'guest',
        status: 'pending',
        orderedAt: new Date().toISOString()
      };
      storageSet(id, order);
      loadOrders();
      setOrderForm({ customerName: '', phone: '', address: '', items: '', notes: '' });
      alert('ðŸŽ‰ Order placed successfully!');
    } catch (e) {
      alert('Order failed');
    }
  };

  const products = [
    { id: 1, name: 'Fresh Tomatoes', category: 'vegetables', price: 40, unit: 'kg', image: 'https://images.unsplash.com/photo-1592924357228-91a4daadcfea?w=400', stock: 100 },
    { id: 2, name: 'Organic Spinach', category: 'vegetables', price: 30, unit: 'bunch', image: 'https://images.unsplash.com/photo-1576045057995-568f588f82fb?w=400', stock: 50 },
    { id: 3, name: 'Farm Potatoes', category: 'vegetables', price: 25, unit: 'kg', image: 'https://images.unsplash.com/photo-1518977676601-b53f82aba655?w=400', stock: 200 },
    { id: 4, name: 'Sweet Carrots', category: 'vegetables', price: 35, unit: 'kg', image: 'https://images.unsplash.com/photo-1598170845058-32b9d6a5da37?w=400', stock: 80 },
    { id: 5, name: 'Fresh Mangoes', category: 'fruits', price: 80, unit: 'kg', image: 'https://images.unsplash.com/photo-1605027990121-cbae9def9d5f?w=400', stock: 60 },
    { id: 6, name: 'Ripe Bananas', category: 'fruits', price: 50, unit: 'dozen', image: 'https://images.unsplash.com/photo-1571771894821-ce9b6c11b08e?w=400', stock: 100 },
    { id: 7, name: 'Sweet Papaya', category: 'fruits', price: 40, unit: 'kg', image: 'https://images.unsplash.com/photo-1617112848923-cc2234396a8d?w=400', stock: 40 },
    { id: 8, name: 'Farm Fresh Milk', category: 'dairy', price: 60, unit: 'liter', image: 'https://images.unsplash.com/photo-1550583724-b2692b85b150?w=400', stock: 150 },
    { id: 9, name: 'Pure Paneer', category: 'dairy', price: 300, unit: 'kg', image: 'https://images.unsplash.com/photo-1631452180519-c014fe946bc7?w=400', stock: 30 },
    { id: 10, name: 'Basmati Rice', category: 'rice', price: 120, unit: 'kg', image: 'https://images.unsplash.com/photo-1586201375761-83865001e31c?w=400', stock: 500 },
    { id: 11, name: 'Brown Rice', category: 'rice', price: 80, unit: 'kg', image: 'https://images.unsplash.com/photo-1536304993881-ff6e9eefa2a6?w=400', stock: 300 },
    { id: 12, name: 'Fresh Butter', category: 'dairy', price: 400, unit: 'kg', image: 'https://images.unsplash.com/photo-1589985270826-4b7bb135bc9d?w=400', stock: 20 },
  ];

  const addToCart = (product) => {
    setCart([...cart, product]);
  };

  const stats = [
    { icon: Users, label: 'Happy Customers', value: customers.length || '500+', color: 'from-green-500 to-emerald-500' },
    { icon: Package, label: 'Products', value: '50+', color: 'from-blue-500 to-cyan-500' },
    { icon: TrendingUp, label: 'Orders/Month', value: orders.length || '1000+', color: 'from-purple-500 to-pink-500' },
    { icon: Award, label: 'Quality Rating', value: '5.0â˜…', color: 'from-orange-500 to-yellow-500' }
  ];

  return (
    <div className="min-h-screen bg-gradient-to-br from-green-50 via-emerald-50 to-teal-50 relative overflow-hidden">
      {/* Rest of your JSX code - keeping it exactly the same */}
      {/* Just use the complete JSX from the original component */}
    </div>
  );
};

export default GreenValleyFarms;
